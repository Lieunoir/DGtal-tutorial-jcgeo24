<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Differential calculus operators - DGtal tutorial jcgeo24</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="../setup.html"><strong aria-hidden="true">1.</strong> Setup</a></li><li class="chapter-item expanded affix "><li class="part-title">Practicals</li><li class="chapter-item expanded "><a href="../thinning.html"><strong aria-hidden="true">2.</strong> Homotopic thinning</a></li><li class="chapter-item expanded "><a href="../estimators.html"><strong aria-hidden="true">3.</strong> Estimators and differential calculus</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../estimators/start.html"><strong aria-hidden="true">3.1.</strong> Getting started</a></li><li class="chapter-item expanded "><a href="../estimators/estimations.html"><strong aria-hidden="true">3.2.</strong> 3D geometric estimations</a></li><li class="chapter-item expanded "><a href="../estimators/operators.html" class="active"><strong aria-hidden="true">3.3.</strong> Differential calculus operators</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">DGtal tutorial jcgeo24</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="differential-calculus-operators"><a class="header" href="#differential-calculus-operators">Differential calculus operators</a></h1>
<p>This section shows how to build a Laplace-Beltrami operator to solve some Dirichlet problems, and how corrected normals can be used to improve its construction.</p>
<p>Solutions can be found in <code>solutions/surface-operators.cpp</code>.</p>
<h2 id="linear-operators"><a class="header" href="#linear-operators">Linear Operators</a></h2>
<p>Our goal is to solve the following Dirichlet Problem :</p>
<p>The way this is usually solved is by building a mass matrix \(M\) (also corresponding to the inner product between 0 forms) and a stiffness matrix \(L\) (corresponding to the integrated Laplace-Beltrami operator). \( \Delta f = g \) can be expressed as \( L \mathbf{f} = M \mathbf{g} \) where \( \mathbf{f} \) and \( \mathbf{g} \) are vectors holding the values of their respective functions at vertices.</p>
<p>There are different ways of obtaining these matrices, including</p>
<ul>
<li><a href="https://lieunoir.github.io/DGtal/moduleNormalCorrectedFEM.html">Finite Element Method</a> (works on triangular and quadrangular surfaces, require normals at faces)</li>
<li><a href="https://lieunoir.github.io/DGtal/classDGtal_1_1InterpolatedCorrectedCalculus.html">Corrected Calculus</a>(works on digital surfaces, require normal at vertices)</li>
<li><a href="https://lieunoir.github.io/DGtal/modulePolygonalCalculus.html">PolyDEC</a>(works on any polygonal surfaces, can be provided a custom embedder)</li>
</ul>
<p>We'll focus here on the finite element method. It can be instanciated with the following line :</p>
<pre><code class="language-cpp">NormalCorrectedFEM&lt;EigenLinearAlgebraBackend, SH3::RealVector, SH3::RealPoint&gt; fem(surfmesh);
</code></pre>
<h4 id="estimating-the-area-again"><a class="header" href="#estimating-the-area-again">Estimating the area (again)</a></h4>
<p>The area can be expresssed as the integral of the function ((1\) over the surface, which is itself the product of the function ((1\) by the function \(1\).</p>
<p>Thus the surface can be estimated by \( \mathbf{1} M \mathbf{1} \).</p>
<p><strong>Exercise</strong>: create an instance of FEM and use it to get a massmatrix. You must attach face normals beforehand to the surfacemesh. Use this matrix to estimate the surface Area. You can also change the normals attached to the surface, rebuild the matrix, and display the surface Area using these matrices.</p>
<h5 id="tips"><a class="header" href="#tips">Tips</a></h5>
<ul>
<li>Results should correspond to the 1st method of the previous part (dot product corrected areas)</li>
<li>In order to obtain a vector of size \( n_v \), you can use the following line :
<pre><code class="language-cpp">  EigenLinearAlgebraBackend::DenseVector myVector(surfmesh.nbVertices);
</code></pre>
Note that you <strong>have</strong> to fill it with values afterward, otherwise it will be nonsensical.
These vectors and the matrices are from the <code>Eigen</code> library, so you can do matrix/vector multiplication, you can transpose them using <code>vec.transpose()</code> etc...</li>
</ul>
<h2 id="solving-the-heat-equation"><a class="header" href="#solving-the-heat-equation"><a name="heat"></a> Solving the heat equation</a></h2>
<p>Recall the heat equation :</p>
<p>\[
\frac{\partial u}{\partial t} = \Delta u
\]</p>
<p>We discretize \(u\) over time as \(u<em>0\), ... , \(u_i\), \(u</em>{i+1}\), with a certain timestep \(dt\).</p>
<p>We can use a forward Euler method to solve our equation numerically :
\[
\begin{split}
\frac{u_{i+1} - u_i}{dt} &amp; = \Delta u_{i+1} \\
u_{i+1} - u_i &amp; = dt\Delta u_{i+1} \\
u_{i+1} - dt\Delta u_{i+1} &amp; = u_i
\end{split}
\]
By integrating over the surface on both side (meaning we multiply by \(M\) we get :</p>
<p>\[
(M - dtL) u_{i+1} = M u_i
\]</p>
<p>We can thus simulate some diffusion by inverting \((M - dt L)\).</p>
<h5 id="choosing-dt"><a class="header" href="#choosing-dt">Choosing \(dt\)</a></h5>
<p>A good value for \(dt\) is \(h*h\) where \(h\) is a characteristic length of the surface (such as the gridstep, or the lenth of an arbitrary edge).
You can also add a slider to add a multiplicative constant to this formula and see the results.</p>
<h5 id="inverting-dt"><a class="header" href="#inverting-dt">Inverting \(dt\)</a></h5>
<p>Since we use <code>Eigen</code>, we also have access to some linear algebrea solvers. In particular, to solve for \(x\) in \(Ax=b\), you can use the following lines :</p>
<pre><code class="language-cp">typedef EigenLinearAlgebraBackend::SolverSimplicialLDLT Solver;
typedef EigenLinearAlgebraBackend::DenseVector DenseVector;
Solver solver;
solver.compute(A);
DenseVector x = solver.solve(b);
</code></pre>
<p><strong>Exercise</strong>: Select an arbitrary point that will serve as a heat source. Build a vector representing the initial heat distribution, 0 everywhere and 1 at the heat source. Simulate some heat diffusion and show the result.</p>
<h5 id="tips-1"><a class="header" href="#tips-1">Tips</a></h5>
<ul>
<li>
<p>Polyscope can be used in order to display some data on our surface. The following line shows how :</p>
<pre><code class="language-cpp">psMesh-&gt;addVertexScalarQuantity( "Some data", myVector );
</code></pre>
</li>
</ul>
<div class="table-wrapper"><table><thead><tr><th>Heat source</th><th>Diffused heat</th></tr></thead><tbody>
<tr><td><img src="/images/diffuse-source.webp" alt="Heat Source" /></td><td><img src="/images/diffused.webp" alt="Diffused Heat" /></td></tr>
</tbody></table>
</div>
<h2 id="smooth-data-interpolation"><a class="header" href="#smooth-data-interpolation"><a name="dirichlet"></a> Smooth data interpolation</a></h2>
<p>We will choose a few random points as the "border" of our surface. By adding constraint at these points, and solving the problem shown at the beginning, we are effectively filling the gaps with a smooth function.</p>
<p>There is a <a href="https://lieunoir.github.io/DGtal/classDGtal_1_1DirichletConditions.html">helper class</a> to solve Dirichlet problems. You can see how to use it <a href="https://lieunoir.github.io/DGtal/moduleNormalCorrectedFEM.html#secLap">here</a> (except that this example uses the border of the surface instead of randomly selected points).</p>
<p><strong>Exercise</strong>: select a few random points that will act as constraints. Interpolate with a harmonic function. Show the resulting function. Again, you can change the attached normals to the mesh and rebuild to see if it makes significant changes.</p>
<div class="table-wrapper"><table><thead><tr><th>Initial values</th><th>Interpolating function</th></tr></thead><tbody>
<tr><td><img src="/images/interpoalte-source.webp" alt="Heat Source" /></td><td><img src="/images/interpoalted.webp" alt="Diffused Heat" /></td></tr>
</tbody></table>
</div>
<h2 id="heat-geodesics"><a class="header" href="#heat-geodesics">Heat geodesics</a></h2>
<p>We now have almost everything we need for the heat geodesic method. This methods (described in <sup class="footnote-reference"><a href="#1">1</a></sup>) gives use the ability to compute an estimate of the distance to a vertex for all the other vertices of a mesh.</p>
<p>The method can be described as follow :</p>
<ul>
<li>Diffuse a heat source at the source point with a small time step (see <a href="#heat">previous section</a>)</li>
<li>Compute the gradient of the result</li>
<li>Normalize this gradient</li>
<li>Compute the divergence of the normalized gradient</li>
<li>Integrate twice the result with a constraint of 0 at the source (see <a href="#dirichlet">other previous section</a></li>
</ul>
<h4 id="gradient-and-divergence"><a class="header" href="#gradient-and-divergence">Gradient and Divergence</a></h4>
<p>The only thing missing is the gradient and divergence computation. Sadly, as of right now, the FEM doesn't give us these operators. We can use instead the calculus provided <a href="https://lieunoir.github.io/DGtal/classDGtal_1_1InterpolatedCorrectedCalculus.html">here</a>.</p>
<p>We can use it in the same way to get the Lapace-Beltrami operators. While it doesn't provide directly the gradient and divergence, we can use the following identities :
\[ grad = D_0 \# \]
\[ div = M_0^{-1} D_0^{-t} M_1 \flat \]
(The \(M_0^{-1}\) is cancelled later so don't actually compute it!)</p>
<p>Gradients are attached to faces, so the vector representing the faces is a vector of size \( 3 \times n_f \). Each block of 3 represent a value.</p>
<p>This method requires normals atached to vertices, not to faces as we currently have. There is a method available to SurfaceMeshes in order to compute vertex normals from face normals, use it!</p>
<p><strong>Exercise</strong>: Choose an arbitrary point randomly, and compute geodesic distance to it using the geodesic method. Display the resulting values in polyscope.</p>
<div class="table-wrapper"><table><thead><tr><th>Source</th><th>Geodesics</th></tr></thead><tbody>
<tr><td><img src="/images/geodesics-source.webp" alt="Heat Source" /></td><td><img src="/images/geodesics.webp" alt="Diffused Heat" /></td></tr>
</tbody></table>
</div>
<h1 id="references"><a class="header" href="#references">References</a></h1>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>Keenan Crane, Clarisse Weischedel, and Max Wardetzky. 2013. Geodesics in heat: A new approach to computing distance based on heat flow. ACM Trans. Graph. 32, 5, Article 152 (September 2013), 11 pages. https://doi.org/10.1145/2516971.2516977</p>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../estimators/estimations.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../estimators/estimations.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
